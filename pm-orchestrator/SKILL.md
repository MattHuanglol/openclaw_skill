---
name: pm-orchestrator
description: Project management orchestrator for software development. Use when user asks to develop/fix code. PM acts as the "Architect/Reviewer" and delegates technical work to "Claude Code" via OpenSpec. Handles Kanban status updates automatically.
---

# PM Orchestrator (Spec-Driven + Kanban Auto)

## ğŸ”— Project Kanban Links
- **Local**: http://localhost:3001/
- **Tailscale / LAN**: http://100.96.208.119:3001/

This skill defines the high-level workflow for software development tasks, enforcing a **Review-First** approach using OpenSpec and strict Kanban synchronization.

## ğŸ­ Roles

- **PM (You)**: 
  - **Manager**: Checks Kanban for tasks, updates status, and reports to user.
  - **Architect**: Writes the initial Proposal (What & Why).
  - **Reviewer**: Reviews technical specs generated by Claude. Approves/Rejects.
  - **Does NOT** write implementation code directly.
- **Claude (Engineer)**:
  - **Planner**: Generates Specs/Design/Tasks based on Proposal.
  - **Coder**: Implements code using the `claude` CLI.
  - **Hard Requirement**: In PM mode, all implementation work must be delegated via the **claude-code skill** (i.e., `claude` CLI). PM does not directly implement application code unless the USER explicitly requests otherwise.
  - **Execution Reliability (Must)**: For any single-shot `claude -p ...` work, run via the **PTY wrapper** from claude-code skill: `scripts/claude_code_run.py` (to reduce hangs/SIGKILL/no-output issues). Only use raw `claude` directly when running an interactive PTY session.

## ğŸ”„ Execution Loop & Workflow

### Phase 1: Task Pickup (Trigger)
**Trigger**: User command OR Periodic Kanban check.
1.  **Identify**: Find the highest priority `Todo` task assigned to "å¦²å·±" (or user specified task).
2.  **Status Update**:
    - Move task to `In-Progress`.
    - `message action=send`: "ğŸš€ é–‹å§‹åŸ·è¡Œä»»å‹™ï¼š[Title] (UUID)"
    - **Enable Patrol**: `openclaw cron enable --id c7438563-e00f-40f0-b7cb-6468e96efef7`

### Phase 2: Progress Monitoring (Heartbeat)
**Trigger**: Periodic Kanban Check (e.g., every 5m).
1.  **Check In-Progress**: Are there tasks in `In-Progress`?
2.  **Check Sub-agents**: Use `process action=list` to see if `claude` is still running.
3.  **Action**:
    - **Stuck**: If no output for >10m, kill and respawn/notify.
    - **Healthy**: Do nothing.

### Phase 3: Spec Generation (Delegate to Claude)
PM delegates to Claude:
```bash
claude -p "Read proposal.md. Generate full specs (specs/*.md), design.md, and tasks.md following OpenSpec conventions." --output-format json && \
openclaw agent --id main --message "claude done: Spec Gen"
```

### Phase 4: Spec Review & Auto-Implement (PM Gate)
**Trigger**: Incoming message "claude done: Spec Gen".
1.  **Wake Up**: PM wakes up upon receiving the message.
2.  **Review**: Read generated specs.
3.  **Decision**:
    -   If valid: **Auto-Proceed** to Phase 5.
    -   Report: "Specs generated & approved. Starting implementation..."
    -   If invalid: Stop and report issues.

### Phase 5: Implementation (Delegate to Claude)
PM delegates to Claude:
```bash
claude -p "Implement the approved tasks defined in openspec/changes/<feature>/tasks.md. Update checklist as you go." --output-format json && \
openclaw message send --target 894437982 --message "ğŸ”” Claude Task Finished! Verifying..." && \
openclaw agent --id main --message "claude done: Implementation <feature>"
```
*(Agent goes to sleep and waits for this internal message)*

### Phase 6: Verification & Delivery
**Trigger**: Incoming message "claude done: Implementation".
1.  **Wake Up**: Check the result log.
2.  **Smoke Test**: Run a quick verification (build/curl/test).
3.  **Kanban Sync**:
    - Mark all implemented subtasks as `done`.
    - Update task status to `Review`.
    - Add a discussion comment summarizing the work.
4.  **Report**: `message action=send` using the **Reporting Template** below.

## â™¾ï¸ The Automation Loop

## ğŸ‘€ Monitoring (Multi-Task, Event-Driven)

### Goal
- Support **multiple concurrent In-Progress tasks**.
- Run **periodic monitoring every 5 minutes**.
- **Notify only on events**: status change, stuck, finished, or service down.

### Source of Truth
- Use **Project Kanban task discussions** to record run state (run id / phase / timestamps).

### Recommended Monitor Runner
- Use a **Cron job** running with model: `google-gemini-cli/gemini-3-flash-preview`.
- The monitor job should:
  1) Check Kanban server health (e.g. `GET /api/tasks`).
  2) List all tasks in `in-progress` (optionally assignee=å¦²å·±).
  3) For each task, compare current `status/version/updatedAt/open subtasks` with last snapshot.
  4) Detect **stuck** (no `updatedAt` change for N minutes, default 30m) or missing expected process.
  5) On event, **wake PM (main agent)** via `sessions_send` with a concise alert and recommended action.

### Long No-Response Handling (PM-owned)
- In PM mode, the monitor may flag **long no-response** (e.g., no progress/logs for >= 30m).
- After wake, **PM decides** what to do (re-run phase, restart services, request clarification, etc.).
- The monitor should not take high-risk corrective actions by itself unless explicitly authorized.

### Noise Policy
- Do **not** send periodic â€œstill runningâ€ updates.
- Only alert when something changes or needs attention.

This section defines the interaction between PM Agent, Claude, and the Patrol.

### 1. ğŸš€ Start
- **Trigger**: User adds task or PM picks `Todo`.
- **Action**: 
  - Move to `In-Progress`.
  - Enable Patrol: `openclaw cron enable --id ...`
  - Start Claude (Phase 2/5).

### 2. ğŸ›¡ï¸ Monitoring (Patrol)
- **Running**: Patrol notifies User + PM ("âœ… Running").
- **Stuck (>1h)**: Patrol wakes PM ("ğŸš¨ Stuck").
- **Done (Safety)**: Patrol wakes PM ("ğŸ•µï¸â€â™€ï¸ Found JSON").

### 3. ğŸ§  Response (PM)
- **On "Running"**: Check process. If active > 1h, **Touch** Kanban `updated_at` (Renewal).
- **On "Stuck"**: Check process. If dead, **Resume** task.

### 4. ğŸ‰ Completion
- **Trigger**: Claude finishes -> `openclaw agent` to PM.
- **Action**: PM Verifies -> PM Updates Kanban (Review) -> PM Notifies User (`message`).

### 5. ğŸ›‘ Stop
- **Trigger**: User moves to `Done`.
- **Action**: Patrol sees empty list -> `cron disable`.

## âš ï¸ Global Rules
1.  **No Direct Coding**: Always delegate implementation to `claude-code`.
2.  **No Git Push**: Unless explicitly instructed.
3.  **Always Update Kanban**: Status MUST reflect reality (Todo -> In-Progress -> Review).
4.  **Auto-Proceed After User Approval**: Once the USER explicitly confirms â€œé–‹å§‹é–‹ç™¼ / OK é–‹ç™¼ / åšå§â€ç­‰åŒæ„é–‹ç™¼çš„æŒ‡ä»¤å¾Œï¼Œè‹¥æœªå¦è¡Œè¦æ±‚ï¼Œ**ä¸éœ€è¦å†é€æ­¥è©¢å•ç¢ºèª**ï¼ˆä¾‹å¦‚ Spec Review å¾Œã€é–‹å·¥å‰ã€æ¯ä¸€æ­¥å‰ï¼‰ã€‚PM æ‡‰ç›´æ¥ä¾æµç¨‹æ¨é€²åˆ°å®Œæˆï¼ˆåˆ° `Review` éšæ®µä¸¦å›å ±ï¼‰ã€‚åªæœ‰åœ¨é‡åˆ°é‡å¤§ä¸ç¢ºå®šæ€§/é¢¨éšªï¼ˆéœ€æ±‚è¡çªã€è³‡æ–™æ¯€æé¢¨éšªã€éœ€å°å¤–è¡Œç‚ºã€æˆ–å¯èƒ½ç ´å£æ—¢æœ‰åŠŸèƒ½ï¼‰æ™‚æ‰ä¸­é€”è©¢å•ã€‚
5.  **Immediate Delivery Sync (Must)**: Once implementation + smoke test are completed, PM MUST immediately:
    - Append a delivery summary + acceptance checklist to the task discussion, and
    - Move the task to **`Review`**.
    Do not wait for the user to ask for status.
6.  **Wake Event**: Always use `openclaw agent --id main --message` to wake up.

## ğŸ“ Reporting Template
ğŸš€ **ä»»å‹™äº¤ä»˜å ±å‘Š (Task Delivery)**

ğŸ“Œ **ä»»å‹™**ï¼š#[Seq] [Title]
ğŸ”„ **éšæ®µ**ï¼šPhase 6 - Verification & Delivery

ğŸ“ **è®Šæ›´æ‘˜è¦**ï¼š
- [UI/Logic] ...
- [Fix] ...

âœ… **é©—æ”¶æ¸…å–® (Acceptance Checklist)**ï¼š
- [ ] ...
- [ ] ...

ğŸ“Š **çœ‹æ¿ç‹€æ…‹**ï¼šReview
